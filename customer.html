<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìä Dashboard Admin - Kelola Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      .animate-fadeIn {
        animation: fadeIn 0.5s ease-out;
      }

      .animate-slideIn {
        animation: slideIn 0.4s ease-out;
      }

      .animate-scaleIn {
        animation: scaleIn 0.3s ease-out;
      }

      .animate-pulse-once {
        animation: pulse 0.6s ease-in-out;
      }

      .animate-shake {
        animation: shake 0.5s ease-in-out;
      }

      /* Smooth transitions */
      .smooth-transition {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Hover lift effect */
      .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      /* Modal backdrop animation */
      .modal-backdrop {
        animation: fadeIn 0.3s ease-out;
      }

      @media print {
        body * {
          visibility: hidden;
        }
        #strukPrint,
        #strukPrint * {
          visibility: visible;
        }
        #strukPrint {
          position: absolute;
          left: 0;
          top: 0;
          width: 80mm;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <!-- Login Box -->
    <div
      id="loginBox"
      class="max-w-md mx-auto my-16 bg-white p-6 rounded-xl shadow-lg animate-scaleIn"
    >
      <h2
        class="text-2xl font-bold text-center text-red-900 mb-5 animate-fadeIn"
      >
        Login Admin
      </h2>
      <input
        id="email"
        type="email"
        placeholder="Email"
        class="w-full my-2 px-3 py-3 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-900 smooth-transition focus:scale-105"
      />
      <input
        id="password"
        type="password"
        placeholder="Password"
        class="w-full my-2 px-3 py-3 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-900 smooth-transition focus:scale-105"
      />
      <button
        id="loginBtn"
        class="w-full bg-red-900 text-white py-3 rounded-lg font-bold hover:bg-red-800 smooth-transition transform hover:scale-105 active:scale-95"
      >
        Login
      </button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden max-w-7xl mx-auto my-5 px-5">
      <button
        id="logoutBtn"
        class="absolute top-5 right-5 bg-gray-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-700 smooth-transition transform hover:scale-105 active:scale-95"
      >
        Logout
      </button>

      <h2
        class="text-3xl font-bold text-center text-red-900 mb-5 animate-fadeIn"
      >
        Dashboard Admin
      </h2>

      <!-- Tabs -->
      <div class="flex gap-3 mb-5 border-b-2 border-gray-300 animate-slideIn">
        <button
          class="tab px-5 py-3 font-medium text-gray-600 border-b-3 border-transparent hover:text-red-900 smooth-transition transform hover:translate-y-[-2px] active"
          data-tab="orders"
        >
          Pesanan
        </button>
        <button
          class="tab px-5 py-3 font-medium text-gray-600 border-b-3 border-transparent hover:text-red-900 smooth-transition transform hover:translate-y-[-2px]"
          data-tab="menu"
        >
          Kelola Menu
        </button>
      </div>

      <!-- Tab Pesanan -->
      <div id="ordersTab" class="tab-content animate-fadeIn">
        <div
          class="bg-white p-4 rounded-xl mb-5 shadow flex justify-between items-center flex-wrap gap-3 hover-lift smooth-transition"
        >
          <h3 class="text-xl font-semibold m-0">Daftar Pesanan</h3>
          <button
            id="exportExcelBtn"
            class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 smooth-transition transform hover:scale-105 active:scale-95"
          >
            üìä Export ke Excel
          </button>
        </div>
        <div id="ordersList"></div>
      </div>

      <!-- Tab Kelola Menu -->
      <div id="menuTab" class="tab-content hidden">
        <button
          id="addMenuBtn"
          class="bg-red-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-800 smooth-transition transform hover:scale-105 active:scale-95 mb-4"
        >
          ‚ûï Tambah Menu Baru
        </button>

        <div
          class="bg-white rounded-xl overflow-hidden shadow hover-lift smooth-transition"
        >
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-red-900 text-white">
                <th class="p-3 text-left font-semibold">Gambar</th>
                <th class="p-3 text-left font-semibold">Nama</th>
                <th class="p-3 text-left font-semibold">Harga</th>
                <th class="p-3 text-left font-semibold">Kategori</th>
                <th class="p-3 text-left font-semibold">Aksi</th>
              </tr>
            </thead>
            <tbody id="menuTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal Add/Edit Menu -->
    <div
      id="menuModal"
      class="hidden fixed inset-0 bg-black bg-opacity-60 justify-center items-center z-50 p-5 modal-backdrop"
    >
      <div
        class="bg-white p-6 rounded-xl w-full max-w-lg max-h-screen overflow-y-auto animate-scaleIn"
      >
        <div class="flex justify-between items-center mb-5">
          <h2 id="modalTitle" class="text-2xl font-bold text-red-900">
            Tambah Menu
          </h2>
          <button
            id="closeModal"
            class="text-red-900 text-3xl w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded smooth-transition transform hover:rotate-90"
          >
            &times;
          </button>
        </div>

        <form id="menuForm">
          <!-- Photo Upload -->
          <div class="mb-4 animate-slideIn">
            <label class="block mb-2 font-medium">Upload Foto</label>
            <div
              class="bg-yellow-50 border border-yellow-400 text-yellow-800 p-2 rounded-lg mb-3 text-sm"
            >
              ‚ö†Ô∏è Foto disimpan sebagai Base64. Max 500KB untuk performa optimal.
            </div>
            <div
              id="uploadArea"
              class="border-2 border-dashed border-gray-300 rounded-lg p-5 text-center cursor-pointer hover:border-red-900 hover:bg-gray-50 smooth-transition transform hover:scale-[1.02]"
            >
              <input
                type="file"
                id="imageInput"
                accept="image/*"
                class="hidden"
              />
              <p class="text-gray-600">üì∑ Klik atau drag foto ke sini</p>
              <small class="text-gray-500">Max 500KB ‚Ä¢ JPG, PNG</small>
            </div>
            <img
              id="imagePreview"
              class="hidden max-w-full max-h-52 mt-3 rounded-lg animate-fadeIn"
            />
          </div>

          <div class="mb-4 animate-slideIn" style="animation-delay: 0.1s">
            <label class="block mb-2 font-medium">Nama Menu</label>
            <input
              type="text"
              id="menuName"
              placeholder="Bakmi Goreng"
              required
              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-900 smooth-transition focus:scale-105"
            />
          </div>

          <div class="mb-4 animate-slideIn" style="animation-delay: 0.2s">
            <label class="block mb-2 font-medium">Harga (Rp)</label>
            <input
              type="number"
              id="menuPrice"
              placeholder="20000"
              required
              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-900 smooth-transition focus:scale-105"
            />
          </div>

          <div class="mb-4 animate-slideIn" style="animation-delay: 0.3s">
            <label class="block mb-2 font-medium">Kategori</label>
            <select
              id="menuCategory"
              required
              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-900 smooth-transition focus:scale-105"
            >
              <option value="makanan">Makanan</option>
              <option value="telor-bebek">Telor Bebek</option>
              <option value="tambahan">Tambahan</option>
              <option value="minuman">Minuman</option>
            </select>
          </div>

          <button
            type="submit"
            class="w-full bg-red-900 text-white py-3 rounded-lg font-bold hover:bg-red-800 smooth-transition transform hover:scale-105 active:scale-95 animate-slideIn"
            style="animation-delay: 0.4s"
          >
            Simpan
          </button>
        </form>
      </div>
    </div>

    <!-- Hidden Struk for Printing -->
    <div id="strukPrint" class="hidden"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
      import { auth, db } from "./firebase.js";
      import {
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
      import {
        collection,
        onSnapshot,
        orderBy,
        query,
        deleteDoc,
        doc,
        addDoc,
        updateDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      const loginBox = document.getElementById("loginBox");
      const dashboard = document.getElementById("dashboard");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const ordersList = document.getElementById("ordersList");
      const menuTableBody = document.getElementById("menuTableBody");
      const menuModal = document.getElementById("menuModal");
      const menuForm = document.getElementById("menuForm");
      const addMenuBtn = document.getElementById("addMenuBtn");
      const closeModal = document.getElementById("closeModal");
      const modalTitle = document.getElementById("modalTitle");
      const exportExcelBtn = document.getElementById("exportExcelBtn");

      const uploadArea = document.getElementById("uploadArea");
      const imageInput = document.getElementById("imageInput");
      const imagePreview = document.getElementById("imagePreview");

      let editingMenuId = null;
      let uploadedImageBase64 = null;
      let allOrders = [];
      let lastOrderCount = 0;

      // === SOUND NOTIFICATION ===
      function playNotificationSound() {
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();
        const notes = [523.25, 659.25, 783.99];

        notes.forEach((frequency, index) => {
          setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = "sine";

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioContext.currentTime + 0.3
            );

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
          }, index * 150);
        });

        setTimeout(() => {
          speakNotification("Ada orderan baru masuk!");
        }, 500);
      }

      function speakNotification(text) {
        if ("speechSynthesis" in window) {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "id-ID";
          utterance.rate = 1.1;
          utterance.pitch = 1.2;
          utterance.volume = 1.0;
          window.speechSynthesis.speak(utterance);
        }
      }

      // Image upload handlers
      uploadArea.addEventListener("click", () => imageInput.click());

      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) handleImageFile(file);
      });

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("border-red-900", "bg-red-50");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("border-red-900", "bg-red-50");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("border-red-900", "bg-red-50");
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          handleImageFile(file);
        }
      });

      function handleImageFile(file) {
        if (file.size > 500 * 1024) {
          alert("Ukuran file maksimal 500KB untuk performa optimal");
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImageBase64 = e.target.result;
          imagePreview.src = uploadedImageBase64;
          imagePreview.classList.remove("hidden");
          uploadArea.querySelector("p").textContent = "‚úì Foto dipilih";
        };
        reader.readAsDataURL(file);
      }

      // === LOGIN ===
      loginBtn.addEventListener("click", async () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        try {
          await signInWithEmailAndPassword(auth, email, password);
          loginBox.classList.add("hidden");
          dashboard.classList.remove("hidden");

          if (Notification.permission === "default") {
            Notification.requestPermission();
          }

          loadOrders();
          loadMenu();
        } catch (err) {
          alert("Login gagal: " + err.message);
        }
      });

      // === LOGOUT ===
      logoutBtn.addEventListener("click", async () => {
        if (confirm("Yakin ingin logout?")) {
          await signOut(auth);
          dashboard.classList.add("hidden");
          loginBox.classList.remove("hidden");
        }
      });

      // === TAB SWITCHING ===
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach((t) => {
            t.classList.remove("active", "text-red-900", "border-red-900");
            t.classList.add("text-gray-600");
            t.style.borderBottomWidth = "0";
          });

          document.querySelectorAll(".tab-content").forEach((c) => {
            c.classList.add("hidden");
          });

          tab.classList.add("active", "text-red-900");
          tab.classList.remove("text-gray-600");
          tab.style.borderBottom = "3px solid #800020";

          document
            .getElementById(tab.dataset.tab + "Tab")
            .classList.remove("hidden");
        });
      });

      // Set initial active tab styling
      document.querySelector(".tab.active").style.borderBottom =
        "3px solid #800020";

      // === FORMAT TANGGAL ===
      function formatDate(timestamp) {
        if (!timestamp) return "-";
        const date = timestamp.toDate();
        return date.toLocaleString("id-ID", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // === CETAK STRUK ===
      function printStruk(order, orderId) {
        const subtotal = order.subtotal || order.total;
        const tax = order.tax || Math.round(subtotal * 0.11);
        const total = order.total;

        const displayOrderId =
          order.orderId || `LEGACY-${orderId.substring(0, 8)}`;

        const strukContent = `
  <div style="font-family: 'Courier New', monospace; width: 80mm; padding: 10px; background: white;">
    <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
      <h2 style="margin: 5px 0; font-size: 18px;">üçú BAKMI JOGJA</h2>
      <p style="margin: 2px 0;">Mbah Karso Ngumpet</p>
      <p style="margin: 2px 0; font-size: 10px;">${formatDate(
        order.createdAt
      )}</p>
      <p style="margin: 5px 0; font-size: 9px; font-weight: bold; background: #f0f0f0; padding: 3px;">Order ID: ${displayOrderId}</p>
    </div>
      <div style="font-size: 12px;">
        <p><strong>Meja: ${order.meja}</strong></p>
        <p style="border-bottom: 1px dashed #000; margin: 5px 0;"></p>
        
        ${order.items
          .map(
            (item) => `
          <div style="display: flex; justify-content: space-between; margin: 5px 0;">
            <span>${item.qty}x ${item.name}</span>
            <span>Rp ${item.price.toLocaleString()}</span>
          </div>
          ${item.note ? `<div style="font-size: 10px; color: #666; font-style: italic; margin-left: 10px;">üìù ${item.note}</div>` : ''}
          <div style="text-align: right; font-size: 11px; color: #666;">
            Subtotal: Rp ${(item.qty * item.price).toLocaleString()}
          </div>
        `
          )
          .join("")}
      </div>
      
      <div style="border-top: 2px dashed #000; margin-top: 10px; padding-top: 10px;">
        <div style="font-size: 12px;">
          <div style="display: flex; justify-content: space-between; margin: 5px 0;">
            <span>Subtotal:</span>
            <span>Rp ${subtotal.toLocaleString()}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 5px 0;">
            <span>Pajak (11%):</span>
            <span>Rp ${tax.toLocaleString()}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px; font-weight: bold; border-top: 2px solid #000; padding-top: 8px;">
            <span>TOTAL:</span>
            <span>Rp ${total.toLocaleString()}</span>
          </div>
        </div>
        <p style="margin: 15px 0 5px 0; font-size: 11px; text-align: center;">Terima Kasih!</p>
        <p style="margin: 0; font-size: 10px; text-align: center;">Selamat Menikmati üòä</p>
      </div>
    </div>
  `;

        const strukPrint = document.getElementById("strukPrint");
        strukPrint.innerHTML = strukContent;
        strukPrint.classList.remove("hidden");

        window.print();

        setTimeout(() => {
          strukPrint.classList.add("hidden");
        }, 100);
      }

      // === EXPORT TO EXCEL ===
      // === EXPORT TO EXCEL ===
      exportExcelBtn.addEventListener("click", () => {
        if (allOrders.length === 0) {
          alert("Tidak ada data pesanan untuk di-export");
          return;
        }

        const excelData = [];

        allOrders.forEach((order) => {
          // Hitung subtotal & tax (backward compatible untuk order lama)
          const calculatedSubtotal = order.items.reduce(
            (sum, item) => sum + item.qty * item.price,
            0
          );
          const orderSubtotal = order.subtotal || calculatedSubtotal;
          const orderTax = order.tax || Math.round(orderSubtotal * 0.11);
          const orderTotal = order.total;

          const displayOrderId =
            order.orderId ||
            `LEGACY-${order.id ? order.id.substring(0, 8) : "N/A"}`;

          order.items.forEach((item, index) => {
            excelData.push({
              "Order ID": index === 0 ? displayOrderId : "",
              Tanggal: formatDate(order.createdAt),
              "No Meja": order.meja,
              "Nama Menu": item.name,
              Jumlah: item.qty,
              "Harga Satuan": item.price,
              "Subtotal Item": item.qty * item.price,
              "Subtotal Pesanan": index === 0 ? orderSubtotal : "",
              "Pajak (11%)": index === 0 ? orderTax : "",
              "Total Pesanan": index === 0 ? orderTotal : "",
              Catatan: index === 0 ? order.catatan || "-" : "",
            });
          });
        });

        const ws = XLSX.utils.json_to_sheet(excelData);
        ws["!cols"] = [
          { wch: 22 }, // Order ID
          { wch: 18 }, // Tanggal
          { wch: 10 }, // No Meja
          { wch: 25 }, // Nama Menu
          { wch: 8 }, // Jumlah
          { wch: 12 }, // Harga Satuan
          { wch: 14 }, // Subtotal Item
          { wch: 16 }, // Subtotal Pesanan
          { wch: 12 }, // Pajak (11%)
          { wch: 15 }, // Total Pesanan
          { wch: 30 }, // Catatan
        ];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Laporan Pesanan");

        const fileName = `Laporan_Bakmi_Jogja_${
          new Date().toISOString().split("T")[0]
        }.xlsx`;
        XLSX.writeFile(wb, fileName);

        alert("‚úÖ Laporan berhasil di-export!");
      });

      // === LOAD ORDERS ===
      function loadOrders() {
        const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
          const currentOrderCount = snapshot.size;

          if (lastOrderCount > 0 && currentOrderCount > lastOrderCount) {
            playNotificationSound();

            if (Notification.permission === "granted") {
              new Notification("üçú Pesanan Baru!", {
                body: "Ada pesanan baru masuk",
                icon: "üçú",
                tag: "new-order",
              });
            }
          }

          lastOrderCount = currentOrderCount;

          allOrders = [];
          ordersList.innerHTML = "";

          snapshot.forEach((docSnap) => {
            const o = docSnap.data();
            const orderId = docSnap.id;
            allOrders.push({ ...o, id: orderId });

            const catatanHTML = o.catatan
              ? `
              <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 my-3 rounded italic text-gray-600">
                <strong>üìù Catatan:</strong> ${o.catatan}
              </div>
            `
              : "";

            const div = document.createElement("div");
            div.className =
              "bg-white rounded-xl p-4 my-4 shadow hover-lift smooth-transition animate-fadeIn";
            const displayOrderId =
              o.orderId || `LEGACY-${orderId.substring(0, 8)}`;

            const paymentStatusBadge =
              o.paymentStatus === "paid"
                ? '<span class="bg-green-600 text-white text-xs px-2 py-1 rounded-full font-semibold ml-2">‚úÖ LUNAS</span>'
                : o.paymentMethod === "cash"
                ? '<span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-semibold ml-2">‚è≥ UNPAID</span>'
                : "";

            div.innerHTML = `
  <div class="flex justify-between items-start mb-3">
    <div>
      <h3 class="text-xl font-bold text-red-900">Pesanan Meja ${
        o.meja || "-"
      }</h3>
      <p class="text-xs text-gray-400 font-mono mt-1">ID: ${displayOrderId}</p>
    </div>
    <span class="bg-red-900 text-white text-xs px-2 py-1 rounded-full font-semibold">${
      o.paymentMethod === "midtrans" ? "üí≥ Transfer" : "üíµ Cash"
    }</span>
  </div>
  <p class="text-sm text-gray-500 mb-3">${formatDate(o.createdAt)}</p>
  <hr class="mb-3">
              ${o.items
                .map(
                  (i) => `
                <div class="font-mono my-1">
                  ${i.qty}x ${i.name} - Rp${i.price.toLocaleString()}
                  ${i.note ? `<div class="text-xs text-gray-500 italic ml-4">üìù ${i.note}</div>` : ''}
                </div>
              `
                )
                .join("")}
              ${catatanHTML}
              <hr class="my-3">
<div class="text-sm space-y-1 mb-2">
  <div class="flex justify-between">
    <span>Subtotal:</span>
    <span>Rp${(o.subtotal || o.total).toLocaleString()}</span>
  </div>
  <div class="flex justify-between">
    <span>Pajak (11%):</span>
    <span>Rp${(o.tax || 0).toLocaleString()}</span>
  </div>
</div>
<p class="font-bold text-lg text-red-900">Total: Rp${o.total.toLocaleString()}</p>
              <div class="flex gap-2 flex-wrap mt-3">
                ${o.paymentMethod === "cash" && o.paymentStatus !== "paid" 
                  ? `<button class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-green-700 smooth-transition transform hover:scale-105 active:scale-95" onclick="markAsPaid('${orderId}')">‚úÖ Tandai Lunas</button>`
                  : ''}
                <button class="bg-cyan-600 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-cyan-700 smooth-transition transform hover:scale-105 active:scale-95" onclick="printStrukGlobal('${orderId}')">üñ®Ô∏è Cetak Struk</button>
                <button class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-600 smooth-transition transform hover:scale-105 active:scale-95" onclick="deleteOrder('${orderId}')">üóë Hapus</button>
              </div>
            `;
            ordersList.appendChild(div);
          });
        });
      }

      window.printStrukGlobal = (orderId) => {
        const order = allOrders.find((o) => o.id === orderId);
        if (order) printStruk(order, orderId);
      };

      window.deleteOrder = async (id) => {
        if (confirm("Yakin hapus pesanan ini?")) {
          await deleteDoc(doc(db, "orders", id));
          alert("Pesanan dihapus ‚úÖ");
        }
      };

     window.markAsPaid = async (id) => {
        if (confirm("Tandai pesanan ini sebagai LUNAS?")) {
          await updateDoc(doc(db, "orders", id), {
            paymentStatus: "paid"
          });
          
          Swal.fire({
            icon: "success",
            title: "Pembayaran Dikonfirmasi!",
            text: "Pesanan telah ditandai sebagai LUNAS ‚úÖ",
            timer: 2000,
            showConfirmButton: false
          });
        }
      };



      // === LOAD MENU ===
      function loadMenu() {
        const q = query(collection(db, "menu"), orderBy("name", "asc"));
        onSnapshot(q, (snapshot) => {
          menuTableBody.innerHTML = "";
          snapshot.forEach((docSnap) => {
            const m = docSnap.data();
            const menuId = docSnap.id;

            const imageHTML = m.imageBase64
              ? `<img src="${m.imageBase64}" class="w-16 h-16 object-cover rounded-lg border-2 border-gray-200" alt="${m.name}">`
              : `<div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400">No Image</div>`;

            const tr = document.createElement("tr");
            tr.className = "border-b border-gray-200 hover:bg-gray-50";

            const availableStatus = m.available !== false;
            const toggleButtonClass = availableStatus
              ? "bg-green-600 hover:bg-green-700"
              : "bg-gray-500 hover:bg-gray-600";
            const toggleButtonText = availableStatus
              ? "‚úÖ Tersedia"
              : "‚ùå Habis";

            tr.innerHTML = `
              <td class="p-3">${imageHTML}</td>
              <td class="p-3">${m.name}</td>
              <td class="p-3">Rp ${m.price.toLocaleString()}</td>
              <td class="p-3">${m.cat}</td>
              <td class="p-3">
                <div class="flex gap-2 flex-wrap">
                  <button class="bg-gray-600 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-gray-700 transition" onclick="editMenu('${menuId}')">‚úèÔ∏è Edit</button>
                  <button class="${toggleButtonClass} text-white px-3 py-2 rounded-lg text-sm font-bold transition transform hover:scale-105" onclick="toggleAvailability('${menuId}', ${availableStatus})">${toggleButtonText}</button>
                  <button class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-600 transition" onclick="deleteMenu('${menuId}')">üóëÔ∏è Hapus</button>
                </div>
              </td>
            `;
            menuTableBody.appendChild(tr);
          });
        });
      }

      // === ADD MENU ===
      addMenuBtn.addEventListener("click", () => {
        editingMenuId = null;
        modalTitle.textContent = "Tambah Menu Baru";
        menuForm.reset();
        imagePreview.classList.add("hidden");
        uploadedImageBase64 = null;
        uploadArea.querySelector("p").textContent =
          "üì∑ Klik atau drag foto ke sini";
        menuModal.classList.remove("hidden");
        menuModal.classList.add("flex");
      });

      // === EDIT MENU ===
      window.editMenu = async (id) => {
        const docRef = doc(db, "menu", id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const m = docSnap.data();
          editingMenuId = id;
          modalTitle.textContent = "Edit Menu";
          document.getElementById("menuName").value = m.name;
          document.getElementById("menuPrice").value = m.price;
          document.getElementById("menuCategory").value = m.cat;

          if (m.imageBase64) {
            uploadedImageBase64 = m.imageBase64;
            imagePreview.src = m.imageBase64;
            imagePreview.classList.remove("hidden");
            uploadArea.querySelector("p").textContent = "‚úì Foto saat ini";
          }

          menuModal.classList.remove("hidden");
          menuModal.classList.add("flex");
        }
      };

      window.toggleAvailability = async (id, currentStatus) => {
        const newStatus = !currentStatus;
        const statusText = newStatus ? "tersedia" : "habis";

        if (confirm(`Ubah status menu menjadi ${statusText}?`)) {
          await updateDoc(doc(db, "menu", id), {
            available: newStatus,
          });
          alert(`‚úÖ Menu diubah menjadi ${statusText}`);
        }
      };

      // === DELETE MENU ===
      window.deleteMenu = async (id) => {
        if (confirm("Yakin hapus menu ini?")) {
          await deleteDoc(doc(db, "menu", id));
          alert("Menu dihapus ‚úÖ");
        }
      };

      // === SAVE MENU ===
      menuForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const menuData = {
          name: document.getElementById("menuName").value,
          price: parseInt(document.getElementById("menuPrice").value),
          cat: document.getElementById("menuCategory").value,
          imageBase64: uploadedImageBase64 || null,
        };

        if (editingMenuId) {
          await updateDoc(doc(db, "menu", editingMenuId), menuData);
          alert("Menu diupdate ‚úÖ");
        } else {
          await addDoc(collection(db, "menu"), menuData);
          alert("Menu ditambahkan ‚úÖ");
        }

        menuModal.classList.add("hidden");
        menuModal.classList.remove("flex");
        menuForm.reset();
        uploadedImageBase64 = null;
      });

      // === CLOSE MODAL ===
      closeModal.addEventListener("click", () => {
        menuModal.classList.add("hidden");
        menuModal.classList.remove("flex");
      });

      menuModal.addEventListener("click", (e) => {
        if (e.target === menuModal) {
          menuModal.classList.add("hidden");
          menuModal.classList.remove("flex");
        }
      });
    </script>
  </body>
</html>
