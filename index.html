<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üçú Bakmi Jogja - Bah Karso Ngumpet</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 0;
        color: #333;
      }

      nav {
        background: linear-gradient(90deg, #800020, #a0002a);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        flex-wrap: wrap;
        gap: 10px;
      }
      nav h1 {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
      }
      .cart {
        background: white;
        color: #800020;
        padding: 8px 16px;
        border-radius: 30px;
        font-weight: bold;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        font-size: 14px;
      }

      .header {
        text-align: center;
        margin-top: 30px;
        padding: 0 20px;
      }
      .header h2 {
        font-size: 28px;
        color: #800020;
        margin-bottom: 5px;
        font-family: cursive;
      }

      .filters {
        text-align: center;
        margin: 20px 0;
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .filters button {
        background: none;
        border: 2px solid #800020;
        color: #800020;
        border-radius: 20px;
        padding: 8px 18px;
        cursor: pointer;
        transition: 0.3s;
      }
      .filters button.active,
      .filters button:hover {
        background: #800020;
        color: white;
      }

      .menu-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        padding: 20px;
        max-width: 1200px;
        margin: auto;
      }

      /* === CARD STYLE === */
      .card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: 0.3s;
        position: relative;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 18px rgba(128, 0, 32, 0.25);
      }
      .card img,
      .card .emoji {
        width: 100%;
        height: 140px;
        object-fit: cover;
        background: #fff7f7;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 60px;
      }
      .card-content {
        padding: 12px 15px 18px;
        text-align: center;
      }
      .card-content .name {
        font-weight: 600;
        font-size: 16px;
        color: #222;
        margin-bottom: 6px;
      }
      .card-content .price {
        font-weight: bold;
        color: #800020;
        font-size: 15px;
      }
      .addBtn {
        position: absolute;
        bottom: 12px;
        right: 12px;
        background: #800020;
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        transition: 0.2s;
      }
      .addBtn:hover {
        background: #600018;
        transform: scale(1.05);
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 20px;
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        border: 2px solid #800020;
      }
      .closeBtn {
        background: none;
        border: none;
        font-size: 20px;
        position: absolute;
        top: 10px;
        right: 15px;
        cursor: pointer;
        color: #800020;
      }

      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }
      .qty-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .qty-btn {
        background: #800020;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 16px;
        cursor: pointer;
        line-height: 0;
      }
      .qty-btn:hover {
        background: #600018;
      }

      .checkout {
        background: #800020;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        width: 100%;
        margin-top: 15px;
        cursor: pointer;
        font-weight: bold;
      }
      .total {
        text-align: right;
        font-weight: bold;
        margin-top: 10px;
        color: #800020;
        font-size: 18px;
      }

      input.mejaInput,
      textarea.catatanInput {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
      }
    </style>
  </head>
  <body>
    <nav>
      <h1>üçú Bakmi Jogja </h1>
      <div class="cart" id="cartBtn">
        üõí Keranjang (<span id="cartCount">0</span>)
      </div>
    </nav>

    <div class="header">
      <h2>Daftar Menu Makanan & Minuman</h2>
      <p>Bakmi Jogja mbah Karso ngumpet</p>
    </div>

    <div class="filters">
      <button class="active" data-category="all">Semua</button>
      <button data-category="makanan">Makanan</button>
      <button data-category="telor-bebek">Telor Bebek</button>
      <button data-category="tambahan">Tambahan</button>
      <button data-category="minuman">Minuman</button>
    </div>

    <div class="menu-container" id="menuContainer"></div>

    <!-- Modal keranjang -->
    <div class="modal" id="cartModal">
      <div class="modal-content">
        <button class="closeBtn" id="closeModal">&times;</button>
        <h3>Keranjang Pesanan</h3>
        <div id="cartList"></div>
        <input
          type="text"
          placeholder="Nomor Meja"
          id="mejaInput"
          class="mejaInput"
        />
        <textarea
          id="catatanInput"
          placeholder="Tambahkan catatan (opsional)"
          class="catatanInput"
        ></textarea>
        <div class="total" id="cartTotal">Total: Rp 0</div>
        <button class="checkout" id="checkoutBtn">Checkout</button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
      import { db } from "./firebase.js";
      import {
        collection,
        addDoc,
        serverTimestamp,
        onSnapshot,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      const menuContainer = document.getElementById("menuContainer");
      const cartCount = document.getElementById("cartCount");
      const cartBtn = document.getElementById("cartBtn");
      const cartModal = document.getElementById("cartModal");
      const closeModal = document.getElementById("closeModal");
      const cartList = document.getElementById("cartList");
      const cartTotal = document.getElementById("cartTotal");
      const checkoutBtn = document.getElementById("checkoutBtn");
      const mejaInput = document.getElementById("mejaInput");
      const catatanInput = document.getElementById("catatanInput");

      let cart = [];
      let menu = [];

      const menuQuery = query(collection(db, "menu"), orderBy("name", "asc"));
      onSnapshot(menuQuery, (snapshot) => {
        menu = [];
        snapshot.forEach((doc) => menu.push({ id: doc.id, ...doc.data() }));
        renderMenu();
      });

      function renderMenu(category = "all") {
        menuContainer.innerHTML = "";
        const filtered =
          category === "all" ? menu : menu.filter((m) => m.cat === category);
        filtered.forEach((item) => {
          const div = document.createElement("div");
          div.className = "card";
          const imageHTML = item.imageBase64
            ? `<img src="${item.imageBase64}" alt="${item.name}">`
            : `<div class="emoji">${item.emoji || "üçΩÔ∏è"}</div>`;
          div.innerHTML = `
        ${imageHTML}
        <div class="card-content">
          <div class="name">${item.name}</div>
          <div class="price">Rp ${item.price.toLocaleString()}</div>
        </div>
        <button class="addBtn">+</button>
      `;
          div
            .querySelector(".addBtn")
            .addEventListener("click", () => addToCart(item));
          menuContainer.appendChild(div);
        });
      }

      document.querySelectorAll(".filters button").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".filters button")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          renderMenu(btn.dataset.category);
        });
      });

      function addToCart(item) {
        const exist = cart.find((c) => c.id === item.id);
        if (exist) exist.qty++;
        else cart.push({ ...item, qty: 1 });
        updateCart();

        // Notifikasi item ditambahkan
        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "success",
          title: `${item.name} ditambahkan!`,
          showConfirmButton: false,
          timer: 1500,
          timerProgressBar: true,
          background: "#fff8f8",
          color: "#800020",
        });
      }

      function changeQty(id, amount) {
        const item = cart.find((c) => c.id === id);
        if (!item) return;
        item.qty += amount;
        if (item.qty <= 0) cart = cart.filter((c) => c.id !== id);
        updateCart();
      }

      function updateCart() {
        cartCount.textContent = cart.reduce((a, b) => a + b.qty, 0);
        cartList.innerHTML = "";
        let total = 0;

        cart.forEach((item) => {
          const subtotal = item.qty * item.price;
          total += subtotal;
          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
        <div>
          <b>${item.name}</b>
        </div>
        <div class="qty-controls">
          <button class="qty-btn" data-action="minus">‚àí</button>
          <span>${item.qty}</span>
          <button class="qty-btn" data-action="plus">+</button>
          <span>Rp ${subtotal.toLocaleString()}</span>
        </div>
      `;
          div
            .querySelector('[data-action="minus"]')
            .addEventListener("click", () => changeQty(item.id, -1));
          div
            .querySelector('[data-action="plus"]')
            .addEventListener("click", () => changeQty(item.id, 1));
          cartList.appendChild(div);
        });

        cartTotal.textContent = "Total: Rp " + total.toLocaleString();
      }

      checkoutBtn.addEventListener("click", async () => {
        const meja = mejaInput.value.trim();
        const catatan = catatanInput.value.trim();
        if (!meja) {
          Swal.fire({
            icon: "warning",
            title: "Nomor Meja Kosong!",
            text: "Silakan isi nomor meja terlebih dahulu üçΩÔ∏è",
            confirmButtonColor: "#800020",
          });
          return;
        }
        if (cart.length === 0) {
          Swal.fire({
            icon: "info",
            title: "Keranjang Kosong!",
            text: "Tambahkan menu dulu sebelum checkout üòã",
            confirmButtonColor: "#800020",
          });
          return;
        }

        const total = cart.reduce((a, b) => a + b.qty * b.price, 0);
        await addDoc(collection(db, "orders"), {
          meja,
          items: cart.map((c) => ({
            name: c.name,
            qty: c.qty,
            price: c.price,
          })),
          total,
          catatan,
          createdAt: serverTimestamp(),
        });

        // ‚úÖ Custom Notifikasi Pesanan Dikirim
        Swal.fire({
          icon: "success",
          title: "Pesanan Dikirim!",
          text: "Pesanan kamu sudah masuk ke dapur Mbah Karso üçúüî•",
          background: "#fff8f8",
          color: "#800020",
          confirmButtonColor: "#800020",
          showConfirmButton: false,
          timer: 2500,
          timerProgressBar: true,
        });

        cart = [];
        mejaInput.value = "";
        catatanInput.value = "";
        updateCart();
        cartModal.classList.remove("show");
      });

      cartBtn.addEventListener("click", () => cartModal.classList.add("show"));
      closeModal.addEventListener("click", () =>
        cartModal.classList.remove("show")
      );
      cartModal.addEventListener("click", (e) => {
        if (e.target === cartModal) cartModal.classList.remove("show");
      });
    </script>
  </body>
</html>
